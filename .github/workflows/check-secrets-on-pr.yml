name: Check required secrets on PR

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  secret-check:
    name: Check repository secrets and comment on PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Verify required secrets
        id: check
        env:
          SANITY_PREVIEW_SECRET: ${{ secrets.SANITY_PREVIEW_SECRET }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL }}
          SANITY_WRITE_TOKEN: ${{ secrets.SANITY_WRITE_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          N8N_WEBHOOK_SECRET: ${{ secrets.N8N_WEBHOOK_SECRET }}
        run: |
          missing=""
          for v in SANITY_PREVIEW_SECRET NEXT_PUBLIC_SITE_URL SANITY_WRITE_TOKEN ANTHROPIC_API_KEY N8N_WEBHOOK_SECRET; do
            if [ -z "${!v}" ]; then
              missing="$missing $v"
            fi
          done
          echo "missing=${missing## }" >> "$GITHUB_OUTPUT"

      - name: Comment on PR when secrets missing
        if: ${{ steps.check.outputs.missing != '' }}
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const missing = `**Missing repository secrets:**\n${process.env.INPUT_MISSING}`
            const prNumber = context.payload.pull_request.number
            const body = `:warning: I detected missing repository secrets required for CI and preview functionality.\n\n${missing}\nPlease add them via Settings → Secrets and variables → Actions. See .github/README_SECRETS.md for details.`
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body,
            })
        env:
          INPUT_MISSING: ${{ steps.check.outputs.missing }}
